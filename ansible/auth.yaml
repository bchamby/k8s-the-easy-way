---
- name: generate token
  hosts: localhost
  connection: local
  tasks:
    - shell:
        cmd: |
          BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d ' ')
          cat > ./auth/token.csv <<EOF
          ${BOOTSTRAP_TOKEN},kubelet-bootstrap,10001,"system:kubelet-bootstrap"
          EOF

- name: distribute token
  hosts: localhost
  connection: local
  tasks:
    - shell: for host in controller0 controller1 controller2; do gcloud compute scp --zone=us-central1-a ./auth/token.csv ${host}:~/; done

- name: bootstrap kubeconfig
  hosts: localhost
  connection: local
  tasks:
    - shell:
        cmd: |
          KUBERNETES_PUBLIC_ADDRESS=$(gcloud compute addresses describe k8s-the-easy-way --region us-central1 --format 'value(address)')
          BOOTSTRAP_TOKEN=`cat ./auth/token.csv | awk -F',' '{print $1}'`
          kubectl config set-cluster kubernetes-the-easy-way --certificate-authority=./tls/ca.pem --embed-certs=true --server=https://${KUBERNETES_PUBLIC_ADDRESS}:6443 --kubeconfig=./auth/bootstrap.kubeconfig
          kubectl config set-credentials kubelet-bootstrap --token=${BOOTSTRAP_TOKEN} --kubeconfig=./auth/bootstrap.kubeconfig
          kubectl config set-context default --cluster=kubernetes-the-easy-way --user=kubelet-bootstrap --kubeconfig=./auth/bootstrap.kubeconfig
          kubectl config use-context default --kubeconfig=./auth/bootstrap.kubeconfig

- name: kube-proxy kubeconfig
  hosts: localhost
  connection: local
  tasks:
    - shell:
        cmd: |
          KUBERNETES_PUBLIC_ADDRESS=$(gcloud compute addresses describe k8s-the-easy-way --region us-central1 --format 'value(address)')
          kubectl config set-cluster kubernetes-the-easy-way --certificate-authority=./tls/ca.pem --embed-certs=true --server=https://${KUBERNETES_PUBLIC_ADDRESS}:6443 --kubeconfig=./auth/kube-proxy.kubeconfig
          kubectl config set-credentials kube-proxy --client-certificate=./tls/kube-proxy.pem --client-key=./tls/kube-proxy-key.pem --embed-certs=true --kubeconfig=./auth/kube-proxy.kubeconfig
          kubectl config set-context default --cluster=kubernetes-the-easy-way --user=kube-proxy --kubeconfig=./auth/kube-proxy.kubeconfig
          kubectl config use-context default --kubeconfig=./auth/kube-proxy.kubeconfig

- name: distribute kubeconfig files
  hosts: localhost
  connection: local
  tasks:
    - shell: for i in worker0 worker1 worker2; do gcloud compute scp --zone=us-central1-a ./auth/bootstrap.kubeconfig ./auth/kube-proxy.kubeconfig ${i}:~/; done
